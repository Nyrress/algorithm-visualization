<html>
    <head>
        <title>
            Dijkstra
        </title>
        <!--Local CSS import-->
        <link href="src/vis.css" type="text/css" />
        <link rel="stylesheet" href="src/index.css" type="text/css" />
        <!--Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    </head>
    
    <body>
        <h2 id="title">Algorithme de Dijkstra</h2>
        <div id="nav">
            <div class="row">
                <div class="row-content">
                    <h5>Ajouter un noeud</h5>
                    <form name="data-sommet">
                        <button type="button" onclick="addNode()">Ajouter</button>
                    </form>
                </div>
                <div class="row-content">
                    <h5>Ajouter une liaison entre deux noeuds</h5>
                    <form name="data-noeud">
                        <input name="first-node" type="text">
                        <input name="second-node" type="text">
                        <input name="weight" type="text">
                        <button type="button" onclick="addEdge()">Ajouter</button>
                    </form>
                </div>
                <div class="row-content">
                    <h5>Sélectionner le sommet de départ du graphe </h5>
                    <form name="data-node">
                        <input name="start-node" type="text">
                        <button type="button" onclick="nodeDep()">Confirmer</button>
                    </form>
                </div>
            </div>
            
        </div>
        
        <div class="row">
            <div class="row-content" id="mynetwork"></div>
            <div class="row-content"id="tableau">
                <div>
                    <p>Trace de l'algorithme </p>
                    <table class="table" id="table">
                        <thead>
                            <tr id='table-thead'>
                                <td>Iterations</td>
                                <td>d(n)</td>
                                <td>d(n+1)</td>
                                <td>d(n+2)</td>
                                <td>d(...)</td>
                            </tr>
                        </thead>
                        <tbody id='table-tbody'>
                        </tbody>
                    </table>
                </div>
                <div class='table-arcs'>
                    <p>Arcs entre les sommets</p>
                    <table class="table" id="table-arcs">
                        <thead>
                            <tr>
                                <td>Sommet Origine</td>
                                <td>Sommet Recepteur</td>
                                <td>Poid</td>
                            </tr>
                        </thead>
                        <tbody id='table-tbody-arcs'>
                        </tbody>
                    </table>
                </div>     
            </div>
        </div>
        <!-- Boostrap Scripts-->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <!--Script Import -->
        <script src="src/vis.js" type="text/javascript"></script>
        <script src="src/jsgraphs.js" type="text/javascript"></script>


        <!-- Belman Algorithm-->
        <script type="text/javascript">
            //Initialisation
            var nbNodes = 0;
            var g = new jsgraphs.Graph(nbNodes);
            var graph = {}
            graph.sommets = new Array();
            graph.arcs = new Array();

            /**
             * Fonction permettant l'ajout d'un noeud dans le graph
             */
            function addNode(){
                graph.sommets.push(nbNodes)
                nbNodes+=1;
                //On redessine le graphe et on éxécute l'algorithme
                g = new jsgraphs.Graph(nbNodes);
                dessiner();
                dijkstra(graph)
            }

            /**
            * Fonction permettant l'ajout d'un arc entre deux noeuds
            */
            function addEdge(){
                //On récupère la valeur des deux noeuds ainsi que le poid
                var noeud1 = document.getElementsByName('first-node')[0].value;
                var noeud2 = document.getElementsByName('second-node')[0].value;
                var weight = document.getElementsByName('weight')[0].value;

                graph.arcs.push([parseInt(noeud1),parseInt(noeud2),parseInt(weight)]);

                //On redessine le graphe et on éxécute l'algorithme
                g.addEdge(noeud1,noeud2);
                dessiner()
                dijkstra(graph)
            }

            /**
            * Fonction permettant de choisir le sommet de départ
            */
            function nodeDep(){
                //On récupère la valeur des deux noeuds ainsi que le poid
                var sDep = document.getElementsByName('start-node')[0].value;

                dessiner()
                dijkstra(graph, sDep)
            }


            /**
            * Permet de desinner le graph avec la librairie jsgraph
            */
            function dessiner(){
                var l_noeuds = [];
                var l_arcs = [];
                for(var v=0; v < g.V; ++v){
                    g.node(v).label = v; // assigne à chaque noeud son numéro comme label
                    l_noeuds.push({
                        id: v,
                        label: g.node(v).label
                    });
                    
                    var adj_v = g.adj(v);
                    for(var i = 0; i < adj_v.length; ++i) {
                        var w = adj_v[i];
                        //if(w > v) continue; // make sure only one edge between w and v since the graph is undirected
                        l_arcs.push({
                            from: v,
                            to: w
                        });
                    };
                }
                //Création des noeuds
                var noeuds = new vis.DataSet(l_noeuds);
                // Création des arcs
                var arcs = new vis.DataSet(l_arcs);
                // Affichage du canvas
                var container = document.getElementById('mynetwork');
                var data = {
                    nodes: noeuds,
                    edges: arcs
                };
                var options = {};
                var network = new vis.Network(container, data, options);
            }

            /**
            * Algorithme de Dijkstra
            */
            function dijkstra(graph, sDeb) 
            {
                console.log(graph);
                reinitiliaserTab();

                const l_edges = document.getElementById('table-tbody-arcs');
                graph.arcs.forEach(arc => {
                    var tr = document.createElement('tr');
                    for(var i =0 ; i<3; i++){
                        var td = document.createElement('td')
                        td.appendChild(document.createTextNode(arc[i]));
                        tr.appendChild(td);
                    }
                    l_edges.appendChild(tr);
                });

                const distances = {};
                distances[sDeb] = [];
                distances[sDeb].arcs[2] = 0;

                var parent = null;
                var sommetProche = null;
                var dist = Infinity;

                for(var n in distances)
                {
                    if(!distances[n])
                        continue

                    var ndist = distances[n].arcs[2];
                    var adj = graph[n];
                    //Pour chaque sommets adjacents 
                    for(var a in adj) {

                        if(distances[a])
                            continue;
                        // On prend le sommet le plus proche avec la somme des poids le plus faible
                        var d = adj[a] + ndist;

                        if(d < dist) {
                            parent = distances[n];
                            sommetProche = a;
                            dist = d;
                        }
                    }
                }
                    
                //no more distances
                if(dist === Infinity) {
                    break;
                }
                
                distances[sommetProche] = parent.concat(sommetProche);
                distances[sommetProche].arcs[2] = dist;
                
                return distances;
            }
            
            function reinitiliaserTab(){
                var tableHead = document.getElementById('table-thead');
                var tableBody = document.getElementById('table-tbody');

                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }
                while (tableHead.firstChild) {
                    tableHead.removeChild(tableHead.firstChild);
                }
                let th = document.createElement('th');
                th.appendChild(document.createTextNode("Itérations"));
                tableHead.appendChild(th);
            }
        </script>
    </body>
</html>