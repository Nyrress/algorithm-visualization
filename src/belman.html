<html>
    <head>
        <title>
            Bellman-Ford
        </title>
        <meta author content="Vivien Gontier / Théo Carel">
        <!--Local CSS import-->
        <link href="css/vis.css" type="text/css" />
        <link rel="stylesheet" href="css/index.css" type="text/css" />
        <!--Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    </head>
    
    <body>
        <h2 id="title">Bellman-Ford algorithm</h2>
        <div id="nav">
            <div class="row">
                <div class="row-content">
                    <h5>Ajouter un noeud</h5>
                    <form name="data-sommet">
                        <button type="button" onclick="addNode()" id="add-node">Ajouter</button>
                    </form>
                </div>
                <div class="row-content">
                    <h5>Ajouter une liaison entre deux noeuds</h5>
                    <form name="data-noeud">
                        <select name="first-node">
                            <option value="null" disabled>--Select a Node--</option>
                        </select>
                        <select name="second-node">
                            <option value="null" disabled>--Select a Node--</option>
                        </select>
                        <input name="weight" type="text">
                        <button type="button" onclick="addEdge()">Ajouter</button>
                    </form>
                </div>
            </div>
            
        </div>
        
        <div class="row">
            <div class="row-content" id="mynetwork"></div>
            <div class="row-content"id="tableau">
                <div>
                    <table class="table" id="table">
                        <thead class="thead-dark">
                            <tr id='table-thead'>
                                <th>Itération(s)</th>
                                <th>d(n)</th>
                                <th>d(n+1)</th>
                                <th>d(n+2)</th>
                                <th>d(...)</th>
                            </tr>
                        </thead>
                        <tbody class="tbody-dark" id='table-tbody'>
                        </tbody>
                    </table>
                </div>
                <div class='table-arcs'>
                    <table class="table " id="table-arcs">
                        <thead class="thead-dark">
                            <tr>
                                <th>Arc(s)</th>
                                <th>Poid</th>
                            </tr>
                        </thead>
                        <tbody class="tbody-dark" id='table-tbody-arcs'>
                        </tbody>
                    </table>
                </div>     
            </div>
        </div>
        <!-- Boostrap Scripts-->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <!--Script Import -->
        <script src="js/vis.js" type="text/javascript"></script>
        <script src="js/jsgraphs.js" type="text/javascript"></script>


        <!-- Belman Algorithm-->
        <script type="text/javascript">
            //Initialisation
            var nbNodes = 0;
            var g = new jsgraphs.WeightedGraph(nbNodes);
            var graph = {}
            graph.sommets = new Array();
            graph.arcs = new Array();

            const tableHead = document.getElementById('table-thead');
            const tableBody = document.getElementById('table-tbody');


            /**
             * Fonction permettant l'ajout d'un noeud dans le graph
             */
            function addNode(){

                graph.sommets.push(nbNodes)
                nbNodes+=1;
                //On redessine le graphe et on éxécute l'algorithme
                g = new jsgraphs.WeightedDiGraph(nbNodes);
                dessiner();
                bellmanFord(graph)

                //on modifie les select en ajoutant le nouveau noeud 
                var selects = document.querySelectorAll('select');
                selects.forEach(element => {
                    var option = document.createElement('option')
                    option.appendChild(document.createTextNode(nbNodes-1))
                    element.appendChild(option);
                });

                
            }

            /**
            * Fonction permettant l'ajout d'un arc entre deux noeuds
            */
            function addEdge(){
                //On récupère la valeur des deux noeuds ainsi que le poid
                var noeud1 = document.getElementsByName('first-node')[0].value;
                var noeud2 = document.getElementsByName('second-node')[0].value;
                var weight = document.getElementsByName('weight')[0].value;

                graph.arcs.push([parseInt(noeud1),parseInt(noeud2),parseInt(weight)]);

                //On redessine le graphe et on éxécute l'algorithme
                g.addEdge(new jsgraphs.Edge(noeud1,noeud2, weight));
                dessiner()
                bellmanFord(graph)
            }

            /**
            * Permet de desinner le graph avec la librairie jsgraph
            */
            function dessiner(){
                var l_noeuds = [];
                var l_arcs = [];

                for(var v=0; v < g.V; ++v){
                    g.node(v).label = "N : " + v; // assigne à chaque noeud son numéro comme label
                    l_noeuds.push({
                        id: v,
                        label: g.node(v).label
                    });
                    
                    var adj_v = g.adj(v);
                    for(var i = 0; i < adj_v.length; ++i) {
                        var e = adj_v[i]
                        var w = e.other(v)
                        l_arcs.push({
                            from: v,
                            to: w,
                            length : e.weight,
                            label : '' + e.weight,
                            arrows : 'to'
                        });
                    };
                }

                //Création des noeuds
                var noeuds = new vis.DataSet(l_noeuds);
                // Création des arcs
                var arcs = new vis.DataSet(l_arcs);
                // Affichage du canvas
                var container = document.getElementById('mynetwork');
                var data = {
                    nodes: noeuds,
                    edges: arcs
                };
                var options = {};
                var network = new vis.Network(container, data, options);
            }

            /**
            * Algorithme de Bellman-Ford
            */
            function bellmanFord(graph) {
                console.log(graph)
                    if(event.srcElement.id == "add-node"){
                        graph.arcs = new Array();
                    }

                    reinitiliaserTab(function(){
                        const l_edges = document.getElementById('table-tbody-arcs');
                        graph.arcs.forEach(arc => {
                            var tr = document.createElement('tr');
                            for(var i =0 ; i<2; i++){
                                var td = document.createElement('td')
                                if(i==0)
                                    td.appendChild(document.createTextNode(arc[0]+ " --> " +arc[1]));
                                else 
                                    td.appendChild(document.createTextNode(arc[2]));
                                tr.appendChild(td);
                            }
                            l_edges.appendChild(tr);
                        });

                    
                        const distances = {}
                        const sommetsPrecedants = {}
                        const sommets = graph.sommets;
                        const arcs = graph.arcs;
                    
                        
                
                        //Initialise toutes les distances à 0
                        sommets.forEach(sommet => {
                            
                            //Ajoute un sommet au thead du tableau 
                            node = document.createElement('th')
                            node.appendChild(document.createTextNode("d("+sommet+")"))
                            tableHead.appendChild(node);

                            //Initialise les sommets à l'infinie et le sommet à 0
                            sommetsPrecedants[sommet] = null;
                                if(sommet == 0)
                                    distances[0] = 0;
                                else
                                    distances[sommet] = Infinity;
                        });

                        //Boucle pour chaque itérations
                        for(let iteration= 0; iteration< sommets.length - 1; iteration+=1){
                            arcs.forEach(arc => {
                                if(distances[arc[1]] > (distances[arc[0]] + arc[2]))
                                    distances[arc[1]] = distances[arc[0]] + arc[2]
                        
                            });
                            //Ajout d'une ligne dans le tableau à la fin de chaque itération
                            let tr = document.createElement('tr')
                            let legende = document.createElement('td');
                            legende.appendChild(document.createTextNode('Itération : '+ (iteration+1)))
                            tr.appendChild(legende);
                            sommets.forEach(sommet => {
                                let td = document.createElement('td');
                                td.appendChild(document.createTextNode(distances[sommet]))
                                tr.appendChild(td);
                            })
                            tableBody.appendChild(tr);
                    
                        }
                    });
                    
                }

                //Reinitilise les tableaux après l'ajout d'un noeud ou d'un arc
                function reinitiliaserTab(_callback){
                    var tabs = document.querySelectorAll('table')
                    tabs.forEach(element => {

                        var tableBody = element.lastElementChild;
                        let th = document.createElement('th');

                        while (tableBody.firstChild) {
                            tableBody.removeChild(tableBody.firstChild);
                        }
                        if(element.id != "table-arcs"){
                            while (tableHead.firstChild) {
                                tableHead.removeChild(tableHead.firstChild);
                            }
                            th.appendChild(document.createTextNode("Itérations"));
                            tableHead.appendChild(th);
                        }
                    })
                    _callback();
                }
        </script>
        
    </body>
</html>